"use strict";(self.webpackChunkmomento_docs=self.webpackChunkmomento_docs||[]).push([[7766],{16681:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>l});var o=n(74848),s=n(28453);const a={sidebar_position:9,sidebar_label:"Fastly",title:"Integrating Momento Cache with Fastly Compute@Edge",description:"Learn to deploy a Fastly Compute@Edge project that uses Momento Cache via HTTP API."},i=void 0,r={id:"cache/integrations/fastly",title:"Integrating Momento Cache with Fastly Compute@Edge",description:"Learn to deploy a Fastly Compute@Edge project that uses Momento Cache via HTTP API.",source:"@site/docs/cache/integrations/fastly.md",sourceDirName:"cache/integrations",slug:"/cache/integrations/fastly",permalink:"/cache/integrations/fastly",draft:!1,unlisted:!1,editUrl:"https://github.com/momentohq/public-dev-docs/tree/main/docs/cache/integrations/fastly.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9,sidebar_label:"Fastly",title:"Integrating Momento Cache with Fastly Compute@Edge",description:"Learn to deploy a Fastly Compute@Edge project that uses Momento Cache via HTTP API."},sidebar:"cacheSidebar",previous:{title:"Unity",permalink:"/cache/integrations/unity-integration"},next:{title:"Deno",permalink:"/cache/integrations/deno"}},c={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Momento Setup",id:"momento-setup",level:3},{value:"Fastly Setup",id:"fastly-setup",level:3},{value:"Deploying with Fastly",id:"deploying-with-fastly",level:2},{value:"Conclusion",id:"conclusion",level:2}];function h(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.a,{href:"https://www.fastly.com/products/edge-compute",children:"Compute@Edge"})," is Fastly's platform for deploying and running serverless code."]}),"\n",(0,o.jsxs)(t.p,{children:["In this tutorial, we'll walk through the ",(0,o.jsx)(t.a,{href:"https://github.com/momentohq/client-sdk-javascript/tree/main/examples/fastly-compute",children:"example"})," from our ",(0,o.jsx)(t.a,{href:"https://github.com/momentohq/client-sdk-javascript",children:"JavaScript SDK"}),". By the end of the exercise, you'll have a Fastly Compute@Edge project that interacts with Momento Cache via the HTTP API to get, set, and delete some data."]}),"\n",(0,o.jsxs)(t.p,{children:["The HTTP API is lightweight in that you won't need any additional dependencies beyond what Fastly requires and you can use the standard ",(0,o.jsx)(t.code,{children:"fetch"})," HTTP client methods. However, it only provides a basic subset of all of the Momento APIs, such as ",(0,o.jsx)(t.code,{children:"get"}),", ",(0,o.jsx)(t.code,{children:"set"}),", and ",(0,o.jsx)(t.code,{children:"delete"}),", and is currently only available if you use AWS as your cloud provider."]}),"\n",(0,o.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsx)(t.p,{children:"To get this app deployed and running, you'll need to have the following:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["An account with a Git provider such as ",(0,o.jsx)(t.a,{href:"https://github.com/",children:"GitHub"}),", ",(0,o.jsx)(t.a,{href:"https://gitlab.com",children:"GitLab"}),", or ",(0,o.jsx)(t.a,{href:"https://bitbucket.org/",children:"Bitbucket"}),"."]}),"\n",(0,o.jsxs)(t.li,{children:["A ",(0,o.jsx)(t.a,{href:"https://www.fastly.com/",children:"Fastly"})," account."]}),"\n",(0,o.jsxs)(t.li,{children:["A copy or fork of the ",(0,o.jsx)(t.a,{href:"https://github.com/momentohq/client-sdk-javascript",children:"Momento JavaScript SDK"})," in your personal repositories."]}),"\n"]}),"\n",(0,o.jsx)(t.h3,{id:"momento-setup",children:"Momento Setup"}),"\n",(0,o.jsxs)(t.p,{children:["Once you have a copy or fork of the Momento JavaScript SDK in your Git provider account, you're ready to configure the Momento side of things using the ",(0,o.jsx)(t.a,{href:"https://console.gomomento.com",children:"Momento console"}),". You can create an account in the console by providing your email address or linking an existing Google or GitHub account. Once you've logged into the console, click the ",(0,o.jsx)(t.code,{children:"Create Cache"})," button on the top right of the page:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Create Cache button",src:n(62432).A+"",width:"336",height:"258"})}),"\n",(0,o.jsxs)(t.p,{children:["Create a cache called ",(0,o.jsx)(t.code,{children:"worker"})," using AWS. Currently, the Momento HTTP API is supported only by AWS, but you can create the cache in any of the supported AWS regions."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Create cache form",src:n(40764).A+"",width:"1920",height:"694"})}),"\n",(0,o.jsxs)(t.p,{children:["After pressing the ",(0,o.jsx)(t.code,{children:"Create"})," button you'll see the new ",(0,o.jsx)(t.code,{children:"worker"})," cache in the list of available caches."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"New cache",src:n(57557).A+"",width:"1916",height:"472"})}),"\n",(0,o.jsx)(t.p,{children:"Notice the region you created your cache in is also displayed in the list of caches. You'll need to make sure that you choose the same region when generating a Momento API key in the next step."}),"\n",(0,o.jsxs)(t.p,{children:["Navigate to the ",(0,o.jsx)(t.a,{href:"https://consotle.gomomento.com/api_keys",children:"API keys"})," page, and choose the cloud provider and region you used to create your cache. Since the cache is already created, we will use a fine-grained key that will allow the worker to read from and write to the cache; but will not allow it to do control plane operations, such as creating or deleting a cache. This is especially helpful if you want to manage the security of control plane and data plane operations separately."]}),"\n",(0,o.jsxs)(t.p,{children:["Choose the ",(0,o.jsx)(t.code,{children:"Fine-Grained Access Key"})," key type, select ",(0,o.jsx)(t.code,{children:"worker"})," as ",(0,o.jsx)(t.code,{children:"Cache Name"})," from the drop down, and ",(0,o.jsx)(t.code,{children:"readwrite"})," as ",(0,o.jsx)(t.code,{children:"Role Type"}),". The ",(0,o.jsx)(t.code,{children:"Super User Key"})," is used for managing control plane operations. More information about Momento authentication can be found ",(0,o.jsx)(t.a,{href:"/cache/develop/authentication/",children:"here"}),". Hit the ",(0,o.jsx)(t.code,{children:"Generate API Key"})," button."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Generate token",src:n(7550).A+"",width:"3456",height:"1968"})}),"\n",(0,o.jsxs)(t.p,{children:["Copy the ",(0,o.jsx)(t.code,{children:"API Key"})," and ",(0,o.jsx)(t.code,{children:"HTTP Endpoint"})," and save it in a safe place. You'll need to use it later to configure your Fastly Compute@Edge deployment."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Generated token",src:n(6020).A+"",width:"2532",height:"408"})}),"\n",(0,o.jsx)(t.h3,{id:"fastly-setup",children:"Fastly Setup"}),"\n",(0,o.jsxs)(t.p,{children:["Once you have created your Fastly account, you're ready to configure the Fastly side of things using the ",(0,o.jsx)(t.a,{href:"https://manage.fastly.com/services/all",children:"Fastly console"}),". Once you're logged in, click on your account name in the top right corner and select ",(0,o.jsx)(t.code,{children:"Account"}),". Under the ",(0,o.jsx)(t.code,{children:"Personal profile"})," section of the side bar, select ",(0,o.jsx)(t.code,{children:"API tokens"}),". Click on the ",(0,o.jsx)(t.code,{children:"Create Token"})," button in the top right and follow Fastly's instructions for creating a ",(0,o.jsx)(t.a,{href:"https://docs.fastly.com/en/guides/using-api-tokens#creating-api-tokens",children:"user API token"}),". Make sure to save this API token in a safe place."]}),"\n",(0,o.jsxs)(t.p,{children:["Next, you will install the ",(0,o.jsx)(t.a,{href:"https://developer.fastly.com/learning/compute/#install-the-fastly-cli",children:"Fastly CLI"})," and follow the command line prompts for providing the API token you just created:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"brew install fastly/tap/fastly\nfastly profile create\n"})}),"\n",(0,o.jsx)(t.h2,{id:"deploying-with-fastly",children:"Deploying with Fastly"}),"\n",(0,o.jsxs)(t.p,{children:["Now it's time to configure and deploy the application to your Fastly account. As noted before, you need a copy of the Momento JavaScript SDK available in your repository.\nIn this example, we'll deploy from a GitHub repository forked from ",(0,o.jsx)(t.a,{href:"https://github.com/momentohq/client-sdk-javascript",children:"the original"}),"."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Fork SDK Repository",src:n(65980).A+"",width:"2478",height:"84"})}),"\n",(0,o.jsxs)(t.p,{children:["This repository contains a directory under ",(0,o.jsx)(t.code,{children:"examples"})," for ",(0,o.jsx)(t.code,{children:"fastly-compute"})," which contains the example code for interacting with your Momento Cache using the Momento HTTP API."]}),"\n",(0,o.jsxs)(t.p,{children:["Fastly Compute@Edge uses a file called ",(0,o.jsx)(t.code,{children:"fastly.toml"})," to configure the local and deployed execution environments for your edge code. More information about Compute@Edge configuration can be found ",(0,o.jsx)(t.a,{href:"https://developer.fastly.com/reference/compute/fastly-toml/",children:"on their website"}),"."]}),"\n",(0,o.jsx)(t.p,{children:"First let's navigate to the relevant example directory and install the dependencies:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"cd client-sdk-javascript/examples/fastly-compute\nnpm install\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Second, create a ",(0,o.jsx)(t.code,{children:"secrets.json"})," file with the following contents:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:'{\n    "MOMENTO_HTTP_ENDPOINT": "<YOUR-HTTP-ENDPOINT>",\n    "MOMENTO_BACKEND": "<YOUR-MOMENTO-BACKEND-NAME>",\n    "MOMENTO_CACHE": "<YOUR-CACHE-NAME>",\n    "MOMENTO_API_KEY": "<YOUR-MOMENTO-API-KEY>"\n}\n'})}),"\n",(0,o.jsxs)(t.p,{children:["You can set the variable ",(0,o.jsx)(t.code,{children:"MOMENTO_BACKEND"})," to any string value. Make sure that your HTTP endpoint corresponds to the region where you created your Momento Cache. This is the HTTP endpoint value we copied from the ",(0,o.jsx)(t.code,{children:"Generate API Key"})," output on the Momento Console."]}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Note"}),": for production environments, the Momento API Key should be saved in a ",(0,o.jsx)(t.a,{href:"https://developer.fastly.com/reference/api/services/resources/secret-store/",children:"Fastly Secret Store"}),". However, this is a feature currently restricted to beta users, so this example saves the API key in a ",(0,o.jsx)(t.a,{href:"https://developer.fastly.com/reference/api/services/resources/config-store/",children:"Config Store"})," along with the other values specified in the ",(0,o.jsx)(t.code,{children:"secrets.json"})," file."]}),"\n",(0,o.jsxs)(t.p,{children:["Next, you'll want to make sure the contents of your ",(0,o.jsx)(t.code,{children:"secrets.json"})," file match the contents in the ",(0,o.jsx)(t.code,{children:"fastly.toml"})," file."]}),"\n",(0,o.jsxs)(t.p,{children:["Specifically, you'll want to make sure your HTTP endpoint and backend name is provided under the ",(0,o.jsx)(t.code,{children:"[local_server]"})," heading. The local execution environment will use the information supplied under this heading to set up the appropriate backend and config store for your localhost server while you're developing."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:'[local_server]\n\n  [local_server.backends]\n\n    [local_server.backends.<YOUR-MOMENTO-BACKEND-NAME>]\n      url = "https://<YOUR-HTTP-ENDPOINT>"\n\n  [local_server.config_stores]\n\n    [local_server.config_stores.secrets]\n      file = "secrets.json"\n      format = "json"\n'})}),"\n",(0,o.jsxs)(t.p,{children:["Finally, you'll want to make sure all four variables in the ",(0,o.jsx)(t.code,{children:"secrets.json"})," file are copied over to the items under the ",(0,o.jsx)(t.code,{children:"[setup]"})," heading. Fastly will use the information supplied under this heading to create and initialize the appropriate backend and config store resources in the execution environment."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:'[setup]\n\n  [setup.backends]\n\n    [setup.backends.<YOUR-MOMENTO-BACKEND-NAME>]\n      address = "<YOUR-HTTP-ENDPOINT>"\n      port = 443\n\n  [setup.config_stores]\n\n    [setup.config_stores.secrets]\n\n      [setup.config_stores.secrets.items]\n\n        [setup.config_stores.secrets.items.MOMENTO_BACKEND]\n          value = "<YOUR-MOMENTO-BACKEND-NAME>"\n\n        [setup.config_stores.secrets.items.MOMENTO_CACHE]\n          value = "<YOUR-CACHE-NAME>"\n\n        [setup.config_stores.secrets.items.MOMENTO_HTTP_ENDPOINT]\n          value = "<YOUR-HTTP-ENDPOINT>"\n\n        [setup.config_stores.secrets.items.MOMENTO_TOKEN]\n          value = ""<YOUR-MOMENTO-API-KEY>""\n'})}),"\n",(0,o.jsxs)(t.p,{children:["Next, start the development server and navigate to ",(0,o.jsx)(t.a,{href:"http://localhost:7676",children:"localhost:7676"})," to check that it's working."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"fastly compute serve\n"})}),"\n",(0,o.jsxs)(t.p,{children:["The code in this example sets an item in the cache, gets it, deletes it, and returns an HTML response.\nIt uses the ",(0,o.jsxs)(t.a,{href:"https://github.com/momentohq/client-sdk-javascript/blob/main/examples/fastly-compute/src/index.ts#L98",children:[(0,o.jsx)(t.code,{children:"MomentoFetcher"})," class"]})," which provides a small wrapper that adds some error handling to the basic fetch calls to the Momento HTTP API."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-typescript",children:"    const momento = new MomentoFetcher(authToken, httpEndpoint, backend);\n\n    const getResp = await momento.get(cacheName, key);\n    console.log(`Fetching the key when the cache is empty: ${getResp}`);\n\n    await momento.set(cacheName, key, value, 10);\n    console.log(`Set the key-value pair in the cache ${cacheName}`);\n\n    const getRespAfterSet = await momento.get(cacheName, key);\n    console.log(`Fetching the key after setting the value: ${getRespAfterSet}`);\n\n    await momento.delete(cacheName, key);\n    console.log(`Deleted the key-value pair from the cache ${cacheName}`);\n\n    return new Response(`Tested the Momento cache using: <br /> Key: ${key} | Value: ${value}`, {\n      status: 200,\n      headers: new Headers({'Content-Type': 'text/html; charset=utf-8'}),\n    });\n"})}),"\n",(0,o.jsx)(t.p,{children:"What you should see is a simple text response that matches:"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Fastly example response",src:n(68961).A+"",width:"482",height:"110"})}),"\n",(0,o.jsx)(t.p,{children:"When you're ready to run the project on Fastly, run this command to build and deploy:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"fastly compute publish\n"})}),"\n",(0,o.jsxs)(t.p,{children:["If you want to see logs from your deployed service, you can enable log tailing from the same directory where the ",(0,o.jsx)(t.code,{children:"fastly.toml"})," lives:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"fastly log-tail\n"})}),"\n",(0,o.jsxs)(t.p,{children:["More information about deploying to Fastly can be ",(0,o.jsx)(t.a,{href:"https://developer.fastly.com/learning/compute/#deploy-to-a-fastly-service",children:"found here"}),". And more information about logging and monitoring your Fastly Compute@Edge project can be ",(0,o.jsx)(t.a,{href:"https://developer.fastly.com/learning/compute/testing/#live-log-monitoring-in-your-console",children:"found here"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsxs)(t.p,{children:["We hope this quick tutorial has given you an idea of how simple and straightforward it is to deploy a Momento-powered application with Fastly Compute@Edge. Feel free, of course, to dive into the ",(0,o.jsx)(t.a,{href:"https://github.com/momentohq/client-sdk-javascript/tree/main/examples/fastly-compute",children:"example code"})," as well. We hope you'll also enjoy the simplicity of Momento Cache, as you don't have to manage and provision any infrastructure to get up and running."]})]})}function d(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},57557:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/console-caches-worker-f6fe32f41cabf1c18025d4d7e0862f04.png"},62432:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/console-create-cache-90d89709336a49153da1d5b47282742a.png"},40764:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/console-create-worker-cache-form-25675fe8e7d0bc42ae1673e102922af3.png"},68961:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/deployed-fastly-response-0550b74b1ca6e6a86264ad0b78a5727f.png"},7550:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/fgac-worker-auth-9a307c6c961d307eaacb3a86c741f6f1.png"},65980:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/github-fork-js-sdk-3950285fbebfdc6a75982998d63e70d6.png"},6020:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/http-endpoint-auth-token-2c3853dfb362d741488a794b488e55de.png"},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>r});var o=n(96540);const s={},a=o.createContext(s);function i(e){const t=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(a.Provider,{value:t},e.children)}}}]);